# CVE-2020-7460

## Domain knowledge

sendmsg: syscall used to send data on sockets. it takes a `msghdr` that can include ancillary control data (CMSG) aka "control messages" — a sequence of `cmsghdr` + data blocks packed in userspace.

cmsg layout: each `cmsghdr` has a length field (cmsg_len) followed by `cmsg_len - sizeof(header)` bytes of data. there can be many of them back-to-back inside the user buffer.

copyin: kernel uses `copyin()` to read user memory. any time we read the same user buffer multiple times, a race exists — user can modify it between reads. to avoid TOCTOU, either copy the whole user buffer into kernelspace once or carefully validate each element after copying it into a local scratch area.

race surface: freebsd32_copyin_control walks the user buffer once to sum lengths (first fetch) then later re-reads headers and data (second fetch) to actually copy into mbuf — that double fetch is the race.

