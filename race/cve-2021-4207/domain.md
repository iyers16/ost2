# CVE-2021-4207

## Domain knowledge

qxl / spice: para-virtual GPU used by guests to push cursor/graphics to the host via shared memory (SPICE). guests write descriptors (cursor header, chunks) into shared memory that QEMU reads.

shared memory: untrusted/ACID. any multi-step read of guest memory can be raced or changed between reads.

cursor flow: guest fills QXLCursor (header: width,height,type,data_size + chunk pointers) → QEMU reads header fields → allocs host buffer → unpacks chunks (may follow chunk pointers via guest-shared addresses).

race danger: double-fetching header fields (width/height/size) without caching them locally means guest can change values between steps. combined with unchecked math (signed vs size_t) this makes under-allocation → over-copy trivial.

allocation patterns: QEMU often uses g_malloc0 for zeroed allocs, but zeroing doesn’t protect against size mismatches caused by races or integer overflow. always copy untrusted meta into locals before allocation/usage.

