# 2019-CVE-None-QualcommWiFiSB

TOCTOU in modem firmware loading — AP can rewrite modem memory after it’s been signature-checked but before execution.

## Context / ACID
- actors:  
  - AP (linux kernel): loads and authenticates firmware chunks into shared RAM.  
  - modem CPU (ROM → MBA): reads and verifies those chunks, then executes in place.  
- trust assumption: AP should stop writing once MBA starts verifying.  
- flaw: compromised AP can still write to shared RAM while MBA is verifying/booting.

## First thoughts
two processors sharing the same RAM, no enforced lockout or hardware barrier after verification. looks like a cross-core TOCTOU waiting to happen — firmware verifies one thing, executes another.

## Actual trace (short)
- AP writes `mba.mbn` + `modem.bXX` blobs to shared memory.  
- AP signals modem CPU reset → modem’s ROM reads MBA pointer, loads it.  
- MBA authenticates each modem image chunk (modem.b00...b06) sequentially.  
- attacker on AP never disabled access to shared RAM; while MBA verifies `modem.b05`, AP rewrites it right after verification.  
- MBA jumps into verified region (now poisoned) → executes attacker code in modem CPU context.

## Root cause
shared memory between AP and modem lacks write-protection after verification; firmware verification and use occur on different cores asynchronously.

## Exploitability
requires kernel-level control on AP (so already privileged) but gives execution in modem/wifi firmware — valuable for persistence, analysis, or pivoting. attacker can inject a debugger or patch instructions in verified modem/wifi firmware at runtime.

## Patch
none known. likely unpatched because equivalent race also exists earlier (in ROM bootloader), making firmware-layer fixes moot. possibly mitigated by later TrustZone enforcement or hardware separation on newer SoCs.

## Takeaway
cross-core TOCTOU in firmware verification is fatal — once “trusted” firmware reads from mutable shared memory, authenticity guarantees vanish. verification must happen on immutable memory or via hardware-enforced locks, not trust in a cooperating core.

