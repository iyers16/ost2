# CVE-2019-11098

TOCTOU in SPI flash access — firmware re-fetches verified code, enabling mid-boot instruction swap.

## Context / ACID
- actors:  
  - intel CPU executing bootguard → ACM → PEI.  
  - attacker capable of hardware SPI manipulation (FPGA/clip intercept).  
- trust assumption: spi flash contents remain static between verification and execution.  
- flaw: verified firmware (PEI phase) later refetched from SPI flash instead of cached memory.

## First thoughts
classic double fetch scenario — firmware verifies code once, then executes from the same mutable medium. at power-on, before DRAM, everything runs “cache-as-RAM,” so if cache is disabled mid-boot, execution starts pulling live bytes from SPI again. that’s an attack vector you can literally solder into.

## Actual trace (short)
- ACM verifies boot block & PEI code from SPI flash (time of check).  
- after PEI initializes DRAM, firmware disables cache-as-RAM and refetches PEI code for relocation (time of use).  
- attacker swaps SPI flash contents between reads (using FPGA/MITM hardware like **SPISpy**).  
- result: verified image replaced with attacker-controlled bytes just before execution — code exec at firmware privilege.

## Root cause
UEFI firmware reused SPI flash contents after initial verification — missing invariant that verified code must be executed from immutable memory. disabling cache-as-RAM made subsequent fetches unprotected.

## Exploitability
requires physical or board-level access (clip-on SPI or FPGA inline). yields pre-boot arbitrary code execution, persistence, or bootchain compromise (bypass BootGuard, patch PEI logic). reusable on any SPI-based firmware chain (Intel, AMD, embedded).

## Patch
UEFI PI spec update: mandate copying verified firmware volumes into permanent memory (cache-as-RAM → DRAM) before execution to prevent refetching. only mitigates PEI; later phases remain potentially double-fetchable if vendors repeat the pattern.

## Takeaway
secure boot isn’t secure if you keep reading from writable flash — *verification only matters once*. firmware should stage all verified code in immutable memory before use. hardware TOCTOU is still TOCTOU.

