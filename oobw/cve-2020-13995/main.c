
//XENO: Globals
char Gstr[255];
char sBuffer[1000];
//...
/* V2_0, V2_1 */
int number_of_DESs;
segment_info_type *DES_info;
//...
long read_verify(int fh, char *destination, long length, char *sErrorMessage)
{
    long rc;
    long start;
    long file_len;
    static char sTemp[150];

    rc = read(fh, destination, length);
    if (rc == -1) {
        start = lseek(fh, 0, SEEK_CUR);
        file_len = lseek(fh, 0, SEEK_END);
        sprintf(sTemp, "Error reading, read returned %ld. (start = %ld, \
                    read length = %ld, file_length = %ld\n%s\n",
                    rc, start, length, file_len, sErrorMessage);
        errmessage(sTemp);
        iQuit(1);
    }
    else if (rc != length) {
        start = lseek(fh, 0, SEEK_CUR) - rc;
        file_len = lseek(fh, 0, SEEK_END);
        sprintf(sTemp, "Error reading, read returned %ld. (start = %ld, \
                    read length = %ld, file_length = %ld\n%s\n",
                    rc, start, length, file_len, sErrorMessage);
        errmessage(sTemp);
        printf("errno=%d\n", errno);
        iQuit(1);
    }
    return rc;
}

////ACID: hNITF
int main(int argc, char *argv[]){
	//...
    rc = open(sNITFfilename, O_RDONLY| O_BINARY);
	//...
    hNITF = rc;
	//...
	read_verify(hNITF, (char *) sBuffer, 3, "error reading header (# extension segs");
    sBuffer[3] = '\0';
    number_of_DESs = atoi(sBuffer);

    if (number_of_DESs > 0) {
        /* Allocate Space for extension segs information arrays */
        DES_info = (segment_info_type *)malloc(sizeof(segment_info_type) * number_of_DESs);
        
        if (DES_info == NULL) {
            errmessage("Error allocating memory for DES_info");
            iQuit(1);
        }

        /* Read Image subheader / data lengths */

        read_verify(hNITF, sBuffer, 13 * number_of_DESs, "Error reading header / image subheader data lengths");

        temp = sBuffer;

        for (x = 0; x < number_of_DESs; x++) {
            strncpy(Gstr, temp, 4);
            Gstr[4] = '\0';
            DES_info[x].length_of_subheader = atol(Gstr);
            temp += 4;

            strncpy(Gstr, temp, 9);
            Gstr[9] = '\0';
            DES_info[x].length_of_data = atol(Gstr);
            temp += 9;

            DES_info[x].pData = NULL;
            DES_info[x].bFile_written = FALSE;
        }
    }
}
